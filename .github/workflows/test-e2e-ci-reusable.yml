name: 'Test: E2E CI'

on:
  workflow_call:
    inputs:
      branch:
        description: 'GitHub branch/ref to test'
        required: false
        type: string
        default: ''

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}-${{ github.run_id }}

jobs:
  prepare:
    name: 'Prepare E2E'
    if: ${{ !github.event.pull_request.head.repo.fork }}
    runs-on: blacksmith-4vcpu-ubuntu-2204
    permissions:
      packages: write
      contents: read
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.branch || github.ref }}
          fetch-depth: 1

      - name: Login to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push to GHCR
        uses: ./.github/actions/setup-nodejs
        with:
          build-command: 'pnpm build:docker'
          enable-docker-cache: true
        env:
          INCLUDE_TEST_CONTROLLER: 'true'
          IMAGE_BASE_NAME: ghcr.io/${{ github.repository }}
          IMAGE_TAG: pr-${{ github.event.pull_request.number }}-${{ github.run_id }}
          RUNNERS_IMAGE_BASE_NAME: ghcr.io/${{ github.repository_owner }}/runners

      - name: Generate shard matrix
        id: generate-matrix
        run: echo "matrix=$(node packages/testing/playwright/scripts/distribute-tests.mjs --matrix 16 --orchestrate)" >> "$GITHUB_OUTPUT"

  sqlite-sanity:
    needs: [prepare]
    name: 'SQLite: Sanity Check'
    if: ${{ !github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: docker-pull
      docker-image: ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}-${{ github.run_id }}
      test-command: pnpm --filter=n8n-playwright test:container:sqlite:e2e tests/e2e/building-blocks/workflow-entry-points.spec.ts
      shards: 1
      runner: blacksmith-2vcpu-ubuntu-2204
      workers: '1'
      pre-generated-matrix: '[{"shard":1,"images":""}]'

  # Multi-main: postgres + redis + caddy + 2 mains + 1 worker
  # Only runs for internal PRs (not community/fork PRs)
  # Pulls pre-built Docker image from GHCR
  multi-main-e2e:
    needs: [prepare]
    name: 'Multi-Main: E2E'
    if: ${{ !github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: docker-pull
      docker-image: ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}-${{ github.run_id }}
      test-command: pnpm --filter=n8n-playwright test:container:multi-main:e2e
      shards: 16
      runner: blacksmith-2vcpu-ubuntu-2204
      workers: '1'
      use-custom-orchestration: true
      pre-generated-matrix: ${{ needs.prepare.outputs.matrix }}
    secrets: inherit

  # Community PR tests: Local mode with SQLite (no container building, no secrets required)
  # Runs on GitHub-hosted runners without Currents reporting
  community-e2e:
    name: 'Community: E2E'
    if: ${{ github.event.pull_request.head.repo.fork }}
    uses: ./.github/workflows/test-e2e-reusable.yml
    with:
      branch: ${{ inputs.branch }}
      test-mode: local
      test-command: pnpm --filter=n8n-playwright test:local:e2e-only
      shards: 7
      runner: ubuntu-latest
      workers: '1'
      upload-failure-artifacts: true

  # Cleanup ephemeral Docker image from GHCR and local cache after tests complete
  cleanup-docker:
    name: 'Cleanup Docker Image'
    needs: [prepare, multi-main-e2e, sqlite-sanity]
    if: ${{ !failure() && !cancelled() && !github.event.pull_request.head.repo.fork }}
    runs-on: blacksmith-2vcpu-ubuntu-2204
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Cleanup local Docker cache
        run: |
          echo "Removing PR images from local cache..."
          docker rmi ghcr.io/n8n-io/n8n:pr-${{ github.event.pull_request.number }}-${{ github.run_id }} || true
          docker rmi ghcr.io/n8n-io/runners:pr-${{ github.event.pull_request.number }}-${{ github.run_id }} || true
          docker system prune -f || true

      - name: Delete images from GHCR
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_ORG: ${{ github.repository_owner }}
          GHCR_REPO: ${{ github.event.repository.name }}
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "PR context: cleaning all images for PR ${{ github.event.pull_request.number }}"
            node .github/scripts/cleanup-ghcr-images.mjs --pr ${{ github.event.pull_request.number }}
          else
            echo "Merge queue context: cleaning image pr--${{ github.run_id }}"
            node .github/scripts/cleanup-ghcr-images.mjs --tag pr--${{ github.run_id }}
          fi
